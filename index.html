<html>
<head>
    <title>PPL Health</title>
    <script src="tree-sitter.js"></script>
    <style>
        textarea {
            width: 100%;
            height: 100px;
        }
    </style>
</head>
<body>
    <form>
        <fieldset>
            <legend>PPL Health code</legend>
            <textarea id="pplh" disabled></textarea>
        </fieldset>
        <fieldset>
            <legend>Dice code</legend>
            <textarea id="dice" readonly></textarea>
        </fieldset>
    </form>
    <script lang="javascript">
        const addParent = (vars, child, parent) => {
            if (vars[child])
                vars[child].parents.push(parent)
            else
                vars[child] = {parents: [parent]}
        }
        const addParents = (vars, edgesNode) => {
            if (edgesNode.child(0).type == 'identifier')
                addParent(vars, edgesNode.child(2).text, edgesNode.child(0).text)
            else if (edgesNode.child(0).type == 'edges') {
                addParent(vars, edgesNode.child(2).text, edgesNode.child(0).child(2).text)
                addParents(vars, edgesNode.child(0))
            }
            return vars
        }
        const cptIndex = colIndexes => vars => values =>
            (vars || []).reduce((index, variable, i) =>
                index + (2**i)*values[colIndexes[variable]],
            0)
        const importData = async (vars, importNode) => {
            const response = await fetch(importNode.child(2).text)
            const data = await response.text()
            const lines = data.split('\n')
            const cols = lines[0].split(',').reduce((cols, col, i) => {
                cols[0].push(col)
                cols[1][col] = i
                if (!vars[col])
                    vars[col] = {cpt: [[0, 0]]}
                else if (!vars[col].cpt)
                    vars[col].cpt = Array(2**vars[col].parents.length).fill().map(_ => [0, 0])
                return cols
            }, [[], {}])
            lines.slice(1).forEach(line => {
                line = line.split(',')
                if (line.length != cols[0].length)
                    return
                cols[0].forEach(col => {
                    const index = cptIndex(cols[1])(vars[col].parents)(line)
                    vars[col].cpt[index][0] += parseInt(line[cols[1][col]])
                    vars[col].cpt[index][1]++
                })
            })
            return vars
        }
        const genDice = tree => {
            let vars = tree.children
                            .filter(child => child.type == 'edges')
                            .reduce(addParents, {})
            vars = tree.children
                        .filter(child => child.type == 'import')
                        .reduce(importData, vars)
            return vars
        }
        let parser
        const Parser = window.TreeSitter,
            pplh = document.getElementById('pplh'),
            dice = document.getElementById('dice')
        Parser.init()
            .then(() => Parser.Language.load('tree-sitter-pplh.wasm'))
            .then(PPLH => {
                parser = new Parser
                parser.setLanguage(PPLH)
                pplh.disabled = false
            })

        pplh.addEventListener('input', e => {
            // dice.innerHTML = e.target.value
            const tree = parser.parse(e.target.value)
            genDice(tree.rootNode).then(diceCode => dice.innerHTML = JSON.stringify(diceCode))
        })
    </script>
        
</body>
</html>
